(()=>{if(console.log("[Mindful Timer] Content script loaded."),document.getElementById("mindful-timer-overlay")){console.log("[Mindful Timer] Overlay already present. Skipping creation.");return}let r,a=!1;const t=document.createElement("div");t.id="mindful-timer-overlay",t.style.position="fixed",t.style.bottom="20px",t.style.right="20px",t.style.width="150px",t.style.background="rgba(0,0,0,0.7)",t.style.color="#fff",t.style.borderRadius="8px",t.style.padding="10px",t.style.zIndex="999999",t.style.fontFamily="sans-serif",t.style.userSelect="none",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.justifyContent="flex-start";const c=document.createElement("div");c.style.fontSize="18px",c.style.fontWeight="bold",c.style.marginBottom="5px",t.appendChild(c);const s=document.createElement("button");s.textContent="×",s.style.position="absolute",s.style.top="5px",s.style.right="8px",s.style.color="#fff",s.style.background="transparent",s.style.border="none",s.style.cursor="pointer",s.style.fontSize="16px",t.appendChild(s);const n=document.createElement("button");n.style.cursor="pointer",n.style.fontSize="14px",n.style.padding="6px 10px",n.style.marginTop="5px",n.style.color="#333",n.style.background="#ccc",n.style.border="1px solid #666",n.style.borderRadius="4px",n.textContent="Pause",t.appendChild(n),document.body.appendChild(t),chrome.storage.onChanged.addListener((o,e)=>{if(e==="sync"&&o.timerState){console.log("[Mindful Timer] Timer state changed:",o.timerState);const i=o.timerState.newValue;i!=null&&i.isActive?(a=!1,n.textContent=i.isPaused?"Resume":"Pause",r&&clearInterval(r),r=setInterval(l,1e3),l()):i!=null&&i.isActive||(c.textContent="No timer running",n.textContent="Restart")}}),s.addEventListener("click",()=>{console.log("[Mindful Timer] Close button clicked => remove overlay"),t.remove(),r&&clearInterval(r),chrome.runtime.sendMessage({action:"closeOverlay"})}),n.addEventListener("click",()=>{if(a){console.log("[Mindful Timer] “Restart” clicked => sending globalRestart"),chrome.runtime.sendMessage({action:"globalRestart"}),a=!1,n.textContent="Pause",f();return}chrome.storage.sync.get("timerState",o=>{const e=o.timerState;if(!e||!e.isActive){console.log("[Mindful Timer] No timer => globalRestart"),chrome.runtime.sendMessage({action:"globalRestart"});return}e.isPaused?(console.log("[Mindful Timer] Resuming the timer"),chrome.runtime.sendMessage({action:"resumeTimer"}),n.textContent="Pause"):(console.log("[Mindful Timer] Pausing the timer"),chrome.runtime.sendMessage({action:"pauseTimer"}),n.textContent="Resume")})}),chrome.runtime.onMessage.addListener((o,e,i)=>{switch(o.action){case"timerUpdated":console.log("[Mindful Timer] Received timerUpdated => forcing UI refresh"),r&&clearInterval(r),r=setInterval(l,1e3),l(),i({ack:!0});break;case"removeOverlay":t.remove(),r&&clearInterval(r),i({ack:!0});break;case"timerCompleted":a=!0,c.textContent="Session Complete!",o.isActive&&o.soundUrl&&y(o.soundUrl),o.quote&&p(o.quote),n.textContent="Restart",i({ack:!0});break;case"timerStarted":a=!1,n.textContent="Pause",r&&clearInterval(r),r=setInterval(l,1e3),l(),i({ack:!0});break;case"timerPaused":a=!1,n.textContent="Resume",r&&clearInterval(r),r=setInterval(l,1e3),l(),i({ack:!0});break;case"timerResumed":a=!1,n.textContent="Pause",r&&clearInterval(r),r=setInterval(l,1e3),l(),i({ack:!0});break;case"timerReset":a=!1,r&&clearInterval(r),r=setInterval(l,1e3),c.textContent="No timer running",n.textContent="Restart",i({ack:!0});break}return!0});function l(){a||chrome.storage.sync.get("timerState",o=>{const e=o.timerState;if(e&&e.isActive){if(e.isPaused)c.textContent=d(e.timeLeft),n.textContent="Resume";else if(e.endTime){const i=Date.now(),u=e.endTime-i,m=Math.max(0,Math.floor(u/1e3));c.textContent=d(m),n.textContent="Pause"}a=!1,f()}else c.textContent="No timer running",n.textContent="Restart"})}function d(o){const e=Math.floor(o/60).toString().padStart(2,"0"),i=(o%60).toString().padStart(2,"0");return`${e}:${i}`}function y(o){const e=new Audio(o);chrome.storage.sync.get("soundVolume",i=>{const u=i.soundVolume!==void 0?i.soundVolume/100:1;e.volume=u,e.play().catch(m=>{console.error("[Mindful Timer] Audio playback failed:",m)})})}function p(o){const e=document.createElement("div");e.className="quote-text",e.style.marginTop="5px",e.style.color="#fff",e.style.fontSize="12px",e.textContent=`“${o}”`,t.appendChild(e)}function f(){const o=t.querySelector(".quote-text");o&&o.remove()}r=setInterval(l,1e3),l()})();
