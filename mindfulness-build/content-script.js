(()=>{if(console.log("[Mindful Timer] Content script loaded."),document.getElementById("mindful-timer-overlay")){console.log("[Mindful Timer] Overlay already exists. Skipping creation.");return}let a,r=!1;const t=document.createElement("div");t.id="mindful-timer-overlay",t.style.all="initial",t.style.fontFamily="sans-serif",t.style.position="fixed",t.style.bottom="20px",t.style.right="20px",t.style.width="150px",t.style.height="auto",t.style.background="rgba(0, 0, 0, 0.7)",t.style.color="#fff",t.style.borderRadius="8px",t.style.padding="10px",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.justifyContent="center",t.style.fontSize="14px",t.style.zIndex="999999",t.style.userSelect="none",chrome.runtime.onMessage.addListener((o,e,i)=>(console.log("[Mindful Timer] Received message:",o),o.action==="removeOverlay"?(console.log("[Mindful Timer] Removing overlay as per message."),t.remove(),a&&clearInterval(a),i({ack:!0})):o.action==="timerCompleted"&&(console.log("[Mindful Timer] Handling timerCompleted message."),r=!0,l.textContent="Session Complete!",console.log("[Mindful Timer] Displayed 'Session Complete!'"),o.isActive&&o.soundUrl?(console.log("[Mindful Timer] Playing sound:",o.soundUrl),f(o.soundUrl)):console.log("[Mindful Timer] Sound not played. Either not active tab or no soundUrl provided."),o.quote?(console.log("[Mindful Timer] Displaying quote:",o.quote),y(o.quote)):console.log("[Mindful Timer] No quote to display."),n.textContent="Restart",i({ack:!0})),!0));const l=document.createElement("div");l.style.all="unset",l.style.fontSize="18px",l.style.fontWeight="bold",l.style.color="#fff",t.appendChild(l);const s=document.createElement("button");s.textContent="×",s.style.all="unset",s.style.position="absolute",s.style.top="5px",s.style.right="8px",s.style.color="#fff",s.style.background="transparent",s.style.cursor="pointer",s.style.fontSize="16px",t.appendChild(s),s.addEventListener("click",()=>{console.log("[Mindful Timer] Close button clicked. Removing overlay."),t.remove(),a&&clearInterval(a),chrome.runtime.sendMessage({action:"closeOverlay"})});const n=document.createElement("button");n.style.all="unset",n.style.display="inline-block",n.style.cursor="pointer",n.style.fontSize="14px",n.style.padding="6px 10px",n.style.marginTop="5px",n.style.color="#333",n.style.background="#ccc",n.style.border="1px solid #666",n.style.borderRadius="4px",n.textContent="Pause",t.appendChild(n),n.addEventListener("click",()=>{console.log("[Mindful Timer] Action button clicked."),r?(console.log("[Mindful Timer] Restarting timer."),chrome.storage.sync.get(["timerState"],async o=>{const e=o.timerState;if(e&&e.interval&&e.mode)try{await chrome.runtime.sendMessage({action:"startTimer",interval:e.interval,mode:e.mode}),console.log("[Mindful Timer] 'startTimer' message sent to background."),r=!1,l.textContent=u(e.interval*60),n.textContent="Pause";const i=t.querySelector(".quote-text");i&&(i.remove(),console.log("[Mindful Timer] Existing quote removed."))}catch(i){console.error("[Mindful Timer] Failed to send 'startTimer' message:",i)}else console.warn("[Mindful Timer] Timer state is incomplete. Cannot restart timer.")})):chrome.storage.sync.get("timerState",o=>{const e=o.timerState;e&&e.isActive&&(e.isPaused?(chrome.runtime.sendMessage({action:"resumeTimer"}),console.log("[Mindful Timer] Sent 'resumeTimer' message."),n.textContent="Pause"):(chrome.runtime.sendMessage({action:"pauseTimer"}),console.log("[Mindful Timer] Sent 'pauseTimer' message."),n.textContent="Resume"))})}),document.body.appendChild(t),console.log("[Mindful Timer] Overlay created and appended to DOM.");function u(o){const e=Math.floor(o/60).toString().padStart(2,"0"),i=(o%60).toString().padStart(2,"0");return`${e}:${i}`}function f(o){console.log("[Mindful Timer] Attempting to play sound:",o);const e=new Audio(o);chrome.storage.sync.get("soundVolume",i=>{const c=i.soundVolume!==void 0?i.soundVolume/100:1;e.volume=c,e.play().then(()=>{console.log("[Mindful Timer] Audio playback started.")}).catch(d=>{console.error("Audio playback failed:",d)})})}function y(o){const e=document.createElement("div");e.className="quote-text",e.style.marginTop="5px",e.style.color="#fff",e.style.fontSize="12px",e.textContent=`“${o}”`,t.appendChild(e),console.log("[Mindful Timer] Quote displayed:",o)}function m(){r||chrome.storage.sync.get("timerState",o=>{const e=o.timerState;if(e&&e.isActive){if(e.isPaused)l.textContent="Paused",console.log("[Mindful Timer] Timer is paused.");else if(e.endTime){const i=Date.now(),c=e.endTime-i,d=Math.max(0,Math.floor(c/1e3));l.textContent=u(d),console.log(`[Mindful Timer] Timer updated. Time left: ${d} seconds.`)}else l.textContent="No timer running",console.log("[Mindful Timer] No timer running.");if(e.isActive){r=!1,console.log("[Mindful Timer] Timer is active. Resetting isCompleted flag."),n.textContent=e.isPaused?"Resume":"Pause";const i=t.querySelector(".quote-text");i&&(i.remove(),console.log("[Mindful Timer] Existing quote removed."))}}else r||(l.textContent="No timer running",console.log("[Mindful Timer] Displaying 'No timer running'."));e!=null&&e.isActive?n.disabled=!1:(n.disabled=!0,n.textContent="Pause")})}a=setInterval(m,1e3),m()})();
