(()=>{if(console.log("[Mindful Timer] Content script loaded."),document.getElementById("mindful-timer-overlay")){console.log("[Mindful Timer] Overlay already present. Skipping creation.");return}let i,a=!1;const n=document.createElement("div");n.id="mindful-timer-overlay",n.style.position="fixed",n.style.bottom="20px",n.style.right="20px",n.style.width="150px",n.style.background="rgba(0,0,0,0.7)",n.style.color="#fff",n.style.borderRadius="8px",n.style.padding="10px",n.style.zIndex="999999",n.style.fontFamily="sans-serif",n.style.userSelect="none",n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="flex-start";const c=document.createElement("div");c.style.fontSize="18px",c.style.fontWeight="bold",c.style.marginBottom="5px",n.appendChild(c);const s=document.createElement("button");s.textContent="×",s.style.position="absolute",s.style.top="5px",s.style.right="8px",s.style.color="#fff",s.style.background="transparent",s.style.border="none",s.style.cursor="pointer",s.style.fontSize="16px",n.appendChild(s);const o=document.createElement("button");o.style.cursor="pointer",o.style.fontSize="14px",o.style.padding="6px 10px",o.style.marginTop="5px",o.style.color="#333",o.style.background="#ccc",o.style.border="1px solid #666",o.style.borderRadius="4px",o.textContent="Pause",n.appendChild(o),document.body.appendChild(n),chrome.storage.onChanged.addListener((e,t)=>{if(t==="sync"&&e.timerState){console.log("[Mindful Timer] Timer state changed:",e.timerState);const r=e.timerState.newValue;r!=null&&r.isActive?(a=!1,o.textContent=r.isPaused?"Resume":"Pause",i&&clearInterval(i),i=setInterval(l,1e3),l()):r!=null&&r.isActive||(c.textContent="No timer running",o.textContent="Restart")}}),s.addEventListener("click",()=>{console.log("[Mindful Timer] Close button clicked => remove overlay"),n.remove(),i&&clearInterval(i),chrome.runtime.sendMessage({action:"closeOverlay"})}),o.addEventListener("click",()=>{if(a){console.log("[Mindful Timer] “Restart” clicked => sending globalRestart"),chrome.runtime.sendMessage({action:"globalRestart"}),a=!1,o.textContent="Pause",f();return}chrome.storage.sync.get("timerState",e=>{const t=e.timerState;if(!t||!t.isActive){console.log("[Mindful Timer] No timer => globalRestart"),chrome.runtime.sendMessage({action:"globalRestart"});return}t.isPaused?(console.log("[Mindful Timer] Resuming the timer"),chrome.runtime.sendMessage({action:"resumeTimer"}),o.textContent="Pause"):(console.log("[Mindful Timer] Pausing the timer"),chrome.runtime.sendMessage({action:"pauseTimer"}),o.textContent="Resume")})}),chrome.runtime.onMessage.addListener((e,t,r)=>{switch(console.log("[Mindful Timer] Received message:",e),e.action){case"removeOverlay":n.remove(),i&&clearInterval(i),r({ack:!0});break;case"timerCompleted":a=!0,c.textContent="Session Complete!",e.isActive&&e.soundUrl&&y(e.soundUrl),e.quote&&p(e.quote),o.textContent="Restart",r({ack:!0});break;case"timerStarted":case"timerRestarted":a=!1,o.textContent="Pause",i&&clearInterval(i),i=setInterval(l,1e3),l(),r({ack:!0});break;case"timerPaused":a=!1,o.textContent="Resume",i&&clearInterval(i),i=setInterval(l,1e3),l(),r({ack:!0});break;case"timerResumed":a=!1,o.textContent="Pause",i&&clearInterval(i),i=setInterval(l,1e3),l(),r({ack:!0});break;case"timerReset":a=!1,i&&clearInterval(i),i=setInterval(l,1e3),c.textContent="No timer running",o.textContent="Restart",r({ack:!0});break}return!0});function l(){a||chrome.storage.sync.get("timerState",e=>{const t=e.timerState;if(t&&t.isActive){if(t.isPaused)c.textContent=d(t.timeLeft),o.textContent="Resume";else if(t.endTime){const r=Date.now(),u=t.endTime-r,m=Math.max(0,Math.floor(u/1e3));c.textContent=d(m),o.textContent="Pause"}a=!1,f()}else c.textContent="No timer running",o.textContent="Restart"})}function d(e){const t=Math.floor(e/60).toString().padStart(2,"0"),r=(e%60).toString().padStart(2,"0");return`${t}:${r}`}function y(e){const t=new Audio(e);chrome.storage.sync.get("soundVolume",r=>{const u=r.soundVolume!==void 0?r.soundVolume/100:1;t.volume=u,t.play().catch(m=>{console.error("[Mindful Timer] Audio playback failed:",m)})})}function p(e){const t=document.createElement("div");t.className="quote-text",t.style.marginTop="5px",t.style.color="#fff",t.style.fontSize="12px",t.textContent=`“${e}”`,n.appendChild(t)}function f(){const e=n.querySelector(".quote-text");e&&e.remove()}i=setInterval(l,1e3),l()})();
